<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="16x16" href="../assets/img/Logo TF.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../assets/img/Logo TF.png">
  <link rel="icon" type="image/png" sizes="64x64" href="../assets/img/Logo TF.png">
  <title>Cuentas por Pagar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../styles/styles.css">
  <link rel="stylesheet" href="../styles/cxp.css">
  <link rel="stylesheet" href="../styles/backend-indicator.css">
  <!-- Estilos para el componente searchable-select -->
  <link rel="stylesheet" href="../assets/styles/searchable-select.css">
  
  <!-- Bootstrap JavaScript (requerido para modales) - SIN defer para que cargue inmediatamente -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Verificar que Bootstrap se cargó correctamente
    if (typeof bootstrap === 'undefined') {
      console.error('❌ Bootstrap no se cargó correctamente');
    } else {
      console.log('✅ Bootstrap cargado correctamente');
    }
  </script>
  
  <!-- CRÍTICO: Ocultar elementos del sidebar INMEDIATAMENTE para evitar parpadeo -->
  <style>
    /* Ocultar todos los módulos del sidebar inicialmente (solo dentro del sidebar) */
    .sidebar .nav-item:not(#nav-menu),
    .sidebar-nav .nav-item:not(#nav-menu) {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
    }
    /* Permitir que auth.js muestre los elementos con permisos */
    .sidebar .nav-item.permission-granted,
    .sidebar-nav .nav-item.permission-granted {
      display: list-item !important;
      visibility: visible !important;
      opacity: 1 !important;
      height: auto !important;
      overflow: visible !important;
    }
    /* Asegurar que los botones del page-header se mantengan en línea */
    .page-header .col-md-4.text-end {
      display: flex !important;
      flex-direction: row !important;
      align-items: center !important;
      justify-content: flex-end !important;
      gap: 0.5rem !important;
      flex-wrap: nowrap !important;
    }
    .page-header .col-md-4.text-end .btn {
      white-space: nowrap !important;
      flex-shrink: 0 !important;
    }
    @media (max-width: 768px) {
      .page-header .col-md-4.text-end {
        flex-direction: row !important;
        flex-wrap: wrap !important;
      }
    }
  </style>
  
  <!-- Performance Optimizations y Loaders Comunes -->
  <script src="../assets/scripts/performance/performance-init.js" defer></script>
  
  <!-- CRÍTICO: auth.js DEBE cargarse ANTES de common-head-loader.js -->
  <!-- para que los permisos se apliquen antes de que se oculten elementos -->
  <script src="../assets/scripts/auth.js"></script>
  
  <!-- Ahora cargar common-head-loader.js que esperará a que auth.js esté listo -->
  <script src="../assets/scripts/performance/common-head-loader.js"></script>
  <script src="../assets/scripts/script-loader.js" defer></script>
  
  <!-- Scripts críticos específicos de la página -->
  <!-- Script crítico: Restaurar estado del sidebar ANTES de renderizar para evitar parpadeo -->
  <script src="../assets/scripts/menu/sidebar-state.js"></script>
  <!-- Script para actualizar período automáticamente -->
  <script src="../assets/scripts/periodo.js"></script>
  
  <!-- ===== FASE 3: Scripts Base del Sistema (SIN defer) ===== -->
  <!-- CRÍTICO: main.js debe cargarse SIN defer para que funciones base estén disponibles -->
  <script src="../assets/scripts/main.js"></script>
  <!-- CRÍTICO: cache-manager.js debe cargarse ANTES de otros scripts que usan caché -->
  <script src="../assets/scripts/cache-manager.js"></script>
  
  <!-- ===== FASE 4: Firebase (SIN defer) ===== -->
  <!-- CRÍTICO: firebase-init.js debe cargarse PRIMERO para inicializar Firebase -->
  <script type="module" src="../assets/scripts/firebase-init.js"></script>
  <!-- CRÍTICO: firebase-ready.js debe cargarse DESPUÉS de firebase-init.js para verificar disponibilidad -->
  <script src="../assets/scripts/firebase-ready.js"></script>
  
  <!-- ===== FASE 5: Scripts con defer (se ejecutan cuando DOM está listo) ===== -->
  <!-- CRÍTICO: firebase-repo-base.js debe cargarse para que FirebaseRepoBase esté disponible -->
  <script src="../assets/scripts/firebase-repo-base.js" defer></script>
  <!-- CRÍTICO: firebase-repos.js debe cargarse DESPUÉS de firebase-repo-base.js para crear los repositorios -->
  <script src="../assets/scripts/firebase-repos.js" defer></script>
  
  <!-- Scripts específicos del módulo (con defer) -->
  <script src="../assets/scripts/shared/event-handlers.js" defer></script>
  <script src="../assets/scripts/cxp/event-handlers.js" defer></script>
  <script src="../assets/scripts/cxp/uuid-validation.js" defer></script>
  
  <!-- Sistema de limpieza automática de localStorage -->
  <script src="../assets/scripts/localstorage-cleanup.js" defer></script>
</head>
<body>
<!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <img src="../assets/img/Logo TF.png" alt="TitanFleet" style="height: 50px; width: auto;">
        <span class="logo-text">TitanFleet</span>
      </div>
      <button class="btn-close-sidebar" id="closeSidebar"><i class="fas fa-times"></i></button>
    </div>
    <nav class="sidebar-nav">
      <ul class="nav-menu">
        <li class="nav-item" id="nav-menu"><a href="menu.html" class="nav-link"><i class="fa-solid fa-house-chimney"></i><span>Menú</span></a></li>
        <li class="nav-item" id="nav-logistica"><a href="logistica.html" class="nav-link"><i class="fas fa-truck"></i><span>Logística</span></a></li>
        <li class="nav-item" id="nav-facturacion"><a href="facturacion.html" class="nav-link"><i class="fas fa-file-invoice"></i><span>Facturación</span></a></li>
        <li class="nav-item" id="nav-trafico"><a href="trafico.html" class="nav-link"><i class="fas fa-route"></i><span>Tráfico</span></a></li>
        <li class="nav-item" id="nav-operadores"><a href="operadores.html" class="nav-link"><i class="fas fa-user"></i><span>Operadores</span></a></li>        
        <li class="nav-item" id="nav-diesel"><a href="diesel.html" class="nav-link"><i class="fa-solid fa-gas-pump"></i><span>Diesel</span></a></li>
        <li class="nav-item" id="nav-mantenimiento"><a href="mantenimiento.html" class="nav-link"><i class="fa-solid fa-screwdriver-wrench"></i><span>Mantenimiento</span></a></li>
        <li class="nav-item" id="nav-tesoreria"><a href="tesoreria.html" class="nav-link"><i class="fa-solid fa-money-bill"></i><span>Tesoreria</span></a></li>
        <li class="nav-item" id="nav-cxc"><a href="CXC.html" class="nav-link"><i class="fas fa-hand-holding-usd"></i><span>Cuentas x Cobrar</span></a></li>
        <li class="nav-item active" id="nav-cxp"><a href="CXP.html" class="nav-link"><i class="fas fa-credit-card"></i><span>Cuentas x Pagar</span></a></li>
        <li class="nav-item" id="nav-inventario"><a href="inventario.html" class="nav-link"><i class="fa-solid fa-cart-flatbed"></i><span>Inventario</span></a></li>
        <li class="nav-item" id="nav-configuracion"><a href="configuracion.html" class="nav-link"><i class="fa-solid fa-gears"></i><span>Configuración</span></a></li>
        <li class="nav-item" id="nav-reportes"><a href="reportes.html" class="nav-link"><i class="fas fa-chart-line"></i><span>Reportes</span></a></li>
      </ul>
    </nav>
  </div>

<!-- Main Content -->
  <div class="main-content" id="mainContent">
<!-- Top Bar -->
    <div class="top-bar">
      <button class="btn-toggle-sidebar" id="toggleSidebar">
        <i class="fas fa-bars"></i>
      </button>
               <div class="top-bar-content">
           <div class="page-title-section">
             <h1 class="page-title">
               <i class="fas fa-credit-card"></i>
               Cuentas por Pagar
               <span id="backendReadyIndicator" class="backend-loading-indicator" style="display: none;">
                 <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                 <span class="ms-2">Cargando datos...</span>
               </span>
               <span id="backendReadyBadge" class="backend-ready-badge" style="display: none;">
                 <i class="fas fa-check-circle"></i>
                 <span class="ms-2">Listo para trabajar</span>
               </span>
             </h1>
             <div class="current-period">
               <small class="text-muted">Período: </small>
               <span class="period-info" id="currentPeriod"></span>
             </div>
           </div>
                    <div class="user-info">
           <div class="user-details">
             <i class="fas fa-user-circle"></i>
             <span id="currentUserName">Usuario ERP</span>
           </div>
           <div class="user-actions">
             <button class="btn btn-outline-light btn-sm logout-btn" data-action="logout">
               <i class="fas fa-sign-out-alt"></i> <span class="logout-text">Cerrar Sesión</span>
             </button>
           </div>
         </div>
         </div>
    </div>

<!-- Content Area -->
    <div class="content-wrapper" style="padding: 8px;">
      <div class="container-fluid">
        <!-- Page Header -->
        <div class="page-header">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h2 class="mb-2">Cuentas por Pagar</h2>
              <p class="text-muted mb-0">Gestión de facturas de proveedores y solicitudes de pago</p>
            </div>
            <div class="col-md-4 text-end" style="display: flex; flex-direction: row; align-items: center; justify-content: flex-end; gap: 0.5rem; flex-wrap: nowrap;">
              <button class="btn btn-success" data-action="generarEstadoCuentaProveedor" style="white-space: nowrap; flex-shrink: 0;">
                <i class="fas fa-file-pdf"></i> Estado de Cuenta
              </button>
              <button class="btn btn-primary" data-action="abrirModalNuevaFactura" style="white-space: nowrap; flex-shrink: 0;">
                <i class="fas fa-plus"></i> Nueva Factura
              </button>
            </div>
          </div>
        </div>

          <!-- Métricas -->
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card metric-card">
                <div class="card-body text-center">
                  <div class="metric-value" id="totalPendiente">$0.00</div>
                  <div class="metric-label">Total Pendiente</div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card metric-card">
                <div class="card-body text-center">
                  <div class="metric-value" id="facturasPendientes">0</div>
                  <div class="metric-label">Facturas Pendientes</div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card metric-card">
                <div class="card-body text-center">
                  <div class="metric-value" id="solicitudesPendientes">0</div>
                  <div class="metric-label">Solicitudes Pendientes</div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card metric-card">
                <div class="card-body text-center">
                  <div class="metric-value" id="tasaPago">0%</div>
                  <div class="metric-label">Tasa de Pago</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Filtros -->
          <div class="filter-section">
            <div class="row g-3">
              <div class="col-md-3">
                <label for="filtroProveedor" class="form-label">Proveedor</label>
                <input type="text" class="form-control" id="filtroProveedor" placeholder="Buscar por nombre o RFC de proveedor">
              </div>
              <div class="col-md-2">
                <label for="filtroFactura" class="form-label">Factura</label>
                <input type="text" class="form-control" id="filtroFactura" placeholder="Número de factura">
              </div>
              <div class="col-md-2">
                <label for="filtroEstado" class="form-label">Estado</label>
                <input type="text" class="form-control" id="filtroEstado" placeholder="Pendiente, En Solicitud, etc.">
              </div>
              <div class="col-md-2">
                <label for="fechaDesde" class="form-label">Fecha Desde</label>
                <input type="date" class="form-control" id="fechaDesde">
              </div>
              <div class="col-md-2">
                <label for="fechaHasta" class="form-label">Fecha Hasta</label>
                <input type="date" class="form-control" id="fechaHasta">
              </div>
              <div class="col-md-1 d-flex align-items-end">
                <button class="btn btn-outline-secondary btn-sm w-100" data-action="limpiarFiltrosCXP">
                  <i class="fas fa-times"></i>
                  Limpiar Filtros
                </button>
              </div>
            </div>
          </div>

          <!-- Tabs (mantener como configuración; quitar subpestaña Proveedores) -->
          <ul class="nav nav-tabs" id="cxpTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="facturas-tab" data-bs-toggle="tab" data-bs-target="#facturas" type="button" role="tab">
                <i class="fas fa-file-invoice"></i>
                Facturas
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="solicitudes-tab" data-bs-toggle="tab" data-bs-target="#solicitudes" type="button" role="tab">
                <i class="fas fa-paper-plane"></i>
                Solicitudes de Pago
              </button>
            </li>
          </ul>

          <!-- Tab Content -->
          <div class="tab-content" id="cxpTabContent">
            <!-- Tab Facturas -->
            <div class="tab-pane fade show active" id="facturas" role="tabpanel">
              <div class="card mt-3 section-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h5 class="mb-0"><i class="fas fa-file-invoice"></i> Facturas por Pagar</h5>
                  <button class="btn btn-outline-light btn-sm exportar-btn-header" data-action="exportarCXPExcel" title="Exportar a Excel">
                    <i class="fas fa-file-excel"></i> Exportar
                  </button>
                </div>
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="small text-muted">Selecciona múltiples facturas del mismo proveedor para solicitar pago.</div>
                    <div class="btn-group">
                      <button class="btn btn-success btn-sm" data-action="crearSolicitudPagoSeleccionadas">
                        <i class="fas fa-paper-plane"></i> Solicitar Pago (seleccionadas)
                      </button>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover" id="tablaFacturasCXP">
                      <thead>
                        <tr>
                          <th style="width:32px;"><input type="checkbox" id="selectAllFacturasCXP" data-action="toggleSelectAllFacturasCXP"></th>
                          <th>Factura</th>
                          <th>Proveedor</th>
                          <th>Fecha Emisión</th>
                          <th>Fecha Vencimiento</th>
                          <th>Moneda</th>
                          <th>Monto Total</th>
                          <th>Monto Pagado</th>
                          <th>Monto Pendiente</th>
                          <th>Estado</th>
                          <th>Días Vencidos</th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                      <tbody id="tbodyFacturasCXP">
                        <!-- Los datos se cargarán dinámicamente -->
                      </tbody>
                    </table>
                  </div>
                  <div id="paginacionCXP"></div>
                </div>
              </div>
            </div>

            <!-- Tab Solicitudes -->
            <div class="tab-pane fade" id="solicitudes" role="tabpanel">
              <div class="card mt-3 section-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h5 class="mb-0"><i class="fas fa-paper-plane"></i> Solicitudes de Pago</h5>
                  <button class="btn btn-outline-light btn-sm exportar-btn-header" data-action="exportarSolicitudesCXPExcel" title="Exportar a Excel">
                    <i class="fas fa-file-excel"></i> Exportar
                  </button>
                </div>
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="small text-muted">Selecciona múltiples solicitudes para autorizar o rechazar.</div>
                    <div class="btn-group">
                      <button class="btn btn-success btn-sm" data-action="aprobarSolicitudesSeleccionadas">
                        <i class="fas fa-check"></i> Autorizar Seleccionadas
                      </button>
                      <button class="btn btn-danger btn-sm" data-action="rechazarSolicitudesSeleccionadas">
                        <i class="fas fa-times"></i> Rechazar Seleccionadas
                      </button>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover" id="tablaSolicitudesCXP">
                      <thead>
                        <tr>
                          <th style="width:32px;"><input type="checkbox" id="selectAllSolicitudesCXP" data-action="toggleSelectAllSolicitudesCXP"></th>
                          <th>ID Solicitud</th>
                          <th>Factura</th>
                          <th>Proveedor</th>
                          <th>Monto</th>
                          <th>Fecha Solicitud</th>
                          <th>Estado</th>
                          <th>Prioridad</th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                      <tbody id="tbodySolicitudesCXP">
                        <!-- Los datos se cargarán dinámicamente -->
                      </tbody>
                    </table>
                  </div>
                  <div id="paginacionSolicitudesCXP"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Nueva Factura -->
    <div class="modal fade" id="modalNuevaFactura" tabindex="-1" aria-labelledby="modalNuevaFacturaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalNuevaFacturaLabel">
                        <i class="fas fa-file-invoice"></i>
                        Nueva Factura de Proveedor
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formNuevaFactura">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="proveedorFactura" class="form-label">Proveedor *</label>
                                <div class="searchable-select-container">
                                    <div class="search-input-wrapper">
                                        <input 
                                            type="text" 
                                            id="proveedorFactura" 
                                            class="form-control" 
                                            placeholder="Escriba para buscar proveedor..."
                                            autocomplete="off"
                                            required
                                        >
                                        <i class="fas fa-search search-icon"></i>
                                        <button id="btn-clear-proveedorFactura" class="btn btn-outline-secondary btn-sm btn-clear" type="button" title="Limpiar">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div id="select-proveedorFactura" class="filtered-select"></div>
                                </div>
                                <input type="hidden" id="proveedorFactura_value">
                            </div>
                            <div class="col-md-6">
                                <label for="rfcProveedorFactura" class="form-label">RFC del Proveedor</label>
                                <input type="text" class="form-control" id="rfcProveedorFactura" placeholder="Se llena automáticamente" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="numeroFacturaProveedor" class="form-label">Número de Factura *</label>
                                <input type="text" class="form-control" id="numeroFacturaProveedor" required>
                            </div>
                            <div class="col-md-6">
                                <label for="folioFiscalFactura" class="form-label">Folio Fiscal (UUID)</label>
                                <input type="text" class="form-control" id="folioFiscalFactura" placeholder="Número UUID">
                            </div>
                            <div class="col-md-6">
                                <label for="fechaEmisionFactura" class="form-label">Fecha de Emisión *</label>
                                <input type="date" class="form-control" id="fechaEmisionFactura" required>
                            </div>
                            <div class="col-md-6">
                                <label for="fechaVencimientoFactura" class="form-label">Fecha de Vencimiento (informativo)</label>
                                <input type="date" class="form-control" id="fechaVencimientoFactura" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="subtotalFactura" class="form-label">Subtotal *</label>
                                <input type="number" class="form-control" id="subtotalFactura" step="0.01" required oninput="calcularMontoTotalFactura()">
                            </div>
                            <div class="col-md-6">
                                <label for="ivaFactura" class="form-label">IVA *</label>
                                <input type="number" class="form-control" id="ivaFactura" step="0.01" required oninput="calcularMontoTotalFactura()">
                            </div>
                            <div class="col-md-6">
                                <label for="ivaRetenidoFactura" class="form-label">IVA Retenido</label>
                                <input type="number" class="form-control" id="ivaRetenidoFactura" step="0.01" min="0" oninput="calcularMontoTotalFactura()">
                            </div>
                            <div class="col-md-6">
                                <label for="isrRetenidoFactura" class="form-label">ISR Retenido</label>
                                <input type="number" class="form-control" id="isrRetenidoFactura" step="0.01" min="0" oninput="calcularMontoTotalFactura()">
                            </div>
                            <div class="col-md-6">
                                <label for="otrosMontosFactura" class="form-label">Otros Montos</label>
                                <input type="number" class="form-control" id="otrosMontosFactura" step="0.01" placeholder="Puede ser positivo o negativo" oninput="calcularMontoTotalFactura()">
                                <div class="form-text">Ingrese valores positivos o negativos según corresponda</div>
                            </div>
                            <div class="col-md-6">
                                <label for="montoFacturaProveedor" class="form-label">Monto Total (Calculado)</label>
                                <input type="hidden" id="montoFacturaProveedor" step="0.01">
                                <div class="form-control" id="montoFacturaProveedorDisplay" readonly style="background-color: #e9ecef; font-weight: bold; color: #000; padding: 0.375rem 0.75rem; border: 1px solid #ced4da; border-radius: 0.375rem; min-height: calc(1.5em + 0.75rem + 2px);">$0.00</div>
                                <div class="form-text">Calculado automáticamente: Subtotal + IVA - IVA Retenido - ISR Retenido + Otros Montos</div>
                            </div>
                            <div class="col-md-6">
                                <label for="tipoMonedaFactura" class="form-label">Tipo de Moneda</label>
                                <select class="form-select" id="tipoMonedaFactura">
                                    <option value="MXN">MXN - Peso Mexicano</option>
                                    <option value="USD">USD - Dólar Americano</option>
                                </select>
                            </div>
                            <div class="col-md-6" id="grupoTipoCambioFactura" style="display: none;">
                                <label for="tipoCambioFactura" class="form-label">Tipo de cambio (USD a MXN)</label>
                                <input type="number" class="form-control" id="tipoCambioFactura" step="0.0001" placeholder="Ej. 17.2500">
                            </div>
                            <div class="col-12">
                                <label for="descripcionFactura" class="form-label">Descripción</label>
                                <textarea class="form-control" id="descripcionFactura" rows="3" placeholder="Descripción de la factura o servicios recibidos"></textarea>
                            </div>
                            <div class="col-12">
                                <label for="documentosFactura" class="form-label">Documentos (PDF, XML, Imágenes)</label>
                                <input type="file" class="form-control" id="documentosFactura" multiple accept=".pdf,.xml,image/*">
                                <div class="form-text">Puedes adjuntar varios archivos.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="categoriaFactura" class="form-label">Categoría</label>
                                <select class="form-select" id="categoriaFactura">
                                    <option value="servicios">Servicios</option>
                                    <option value="suministros">Suministros</option>
                                    <option value="equipamiento">Equipamiento</option>
                                    <option value="combustible">Combustible</option>
                                    <option value="mantenimiento">Mantenimiento</option>
                                    <option value="otros">Otros</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="prioridadFactura" class="form-label">Prioridad</label>
                                <select class="form-select" id="prioridadFactura">
                                    <option value="normal">Normal</option>
                                    <option value="alta">Alta</option>
                                    <option value="urgente">Urgente</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" data-action="guardarNuevaFactura">
                        <i class="fas fa-save"></i>
                        Guardar Factura
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal Solicitud de Pago -->
    <div class="modal fade" id="modalSolicitudPago" tabindex="-1" aria-labelledby="modalSolicitudPagoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalSolicitudPagoLabel">
                        <i class="fas fa-paper-plane"></i>
                        Crear Solicitud de Pago
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formSolicitudPago">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="proveedorSolicitud" class="form-label">Proveedor *</label>
                                <select class="form-select" id="proveedorSolicitud" required>
                                    <option value="">Seleccionar proveedor...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="montoSolicitud" class="form-label">Monto a Solicitar *</label>
                                <input type="number" class="form-control" id="montoSolicitud" step="0.01" required>
                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i>
                                    Puedes solicitar el monto completo o una parcialidad. Máximo: <span id="maximoSolicitud">$0.00</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="fechaSolicitud" class="form-label">Fecha de Solicitud *</label>
                                <input type="date" class="form-control" id="fechaSolicitud" required>
                            </div>
                            <div class="col-md-6">
                                <label for="fechaRequerida" class="form-label">Fecha Requerida de Pago *</label>
                                <input type="date" class="form-control" id="fechaRequerida" required>
                            </div>
                            <div class="col-md-6">
                                <label for="prioridadSolicitud" class="form-label">Prioridad *</label>
                                <select class="form-select" id="prioridadSolicitud" required>
                                    <option value="normal">Normal</option>
                                    <option value="alta">Alta</option>
                                    <option value="urgente">Urgente</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="metodoPagoSolicitud" class="form-label">Método de Pago Preferido</label>
                                <select class="form-select" id="metodoPagoSolicitud">
                                    <option value="transferencia">Transferencia Bancaria</option>
                                    <option value="cheque">Cheque</option>
                                    <option value="efectivo">Efectivo</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="facturasSeleccionadas" class="form-label">Facturas a Incluir</label>
                                <div id="facturasSeleccionadas" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                    <!-- Las facturas se cargarán dinámicamente -->
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="justificacionSolicitud" class="form-label">Justificación *</label>
                                <textarea class="form-control" id="justificacionSolicitud" rows="3" required placeholder="Justificación del pago y detalles adicionales"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" data-action="crearSolicitudPago">
                        <i class="fas fa-paper-plane"></i>
                        Enviar Solicitud
                    </button>
                </div>
            </div>
        </div>
    </div>

  <!-- Modal para Estado de Cuenta -->
  <div class="modal fade" id="modalEstadoCuentaProveedor" tabindex="-1" aria-labelledby="modalEstadoCuentaProveedorLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEstadoCuentaProveedorLabel">
            <i class="fas fa-file-pdf"></i>
            Generar Estado de Cuenta
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="proveedorEstadoCuenta" class="form-label">Seleccionar Proveedor</label>
            <select class="form-select" id="proveedorEstadoCuenta" required>
              <option value="">Seleccionar proveedor...</option>
            </select>
          </div>
          
          <div class="row g-3">
            <div class="col-md-6">
              <label for="fechaDesdeEstadoProveedor" class="form-label">Fecha Desde</label>
              <input type="date" class="form-control" id="fechaDesdeEstadoProveedor">
            </div>
            <div class="col-md-6">
              <label for="fechaHastaEstadoProveedor" class="form-label">Fecha Hasta</label>
              <input type="date" class="form-control" id="fechaHastaEstadoProveedor">
            </div>
          </div>
          
          <div class="mt-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="soloVencidasProveedor" checked>
              <label class="form-check-label" for="soloVencidasProveedor">
                Solo facturas vencidas y pendientes
              </label>
            </div>
          </div>
          
          <div class="mt-3" id="previewEstadoCuentaProveedor" style="display: none;">
            <h6>Vista previa:</h6>
            <div class="alert alert-info">
              <strong>Proveedor:</strong> <span id="previewProveedor"></span><br>
              <strong>Período:</strong> <span id="previewPeriodoProveedor"></span><br>
              <strong>Facturas encontradas:</strong> <span id="previewCantidadProveedor"></span><br>
              <strong>Total pendiente:</strong> $<span id="previewTotalProveedor"></span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-info" data-action="previewEstadoCuentaProveedor">
            <i class="fas fa-eye"></i> Vista Previa
          </button>
          <button type="button" class="btn btn-success" data-action="generarPDFEstadoCuentaProveedor">
            <i class="fas fa-file-pdf"></i> Generar PDF
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== SCRIPTS ESENCIALES (Carga Inmediata) ===== -->
  <!-- ===== SCRIPTS COMUNES Y MÓDULOS (Carga automática) ===== -->
  <script src="../assets/scripts/performance/common-head-loader.js"></script>
  <script src="../assets/scripts/performance/common-scripts-loader.js"></script>
  <script src="../assets/scripts/performance/page-modules-config.js"></script>
  <script src="../assets/scripts/performance/page-modules-loader.js"></script>
  <script src="../assets/scripts/paginacion.js" defer></script>
  <!-- cxp.js y tesoreria.js se cargan automáticamente por page-modules-loader.js -->
  <!-- Scripts del componente searchable-select -->
  <script src="../assets/scripts/searchable-select.js"></script>
  <!-- Script de inicialización para searchable-select de proveedores -->
  <script src="../assets/scripts/cxp/searchable-select-proveedores.js" defer></script>
  <script src="../assets/scripts/menu/sidebar-handler.js"></script>
  <!-- Script para indicador de carga del backend (compartido) -->
  <script src="../assets/scripts/backend-ready-indicator.js"></script>
</body>
</html>
