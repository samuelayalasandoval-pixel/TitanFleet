<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/img/Logo TF.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/img/Logo TF.png" />
    <link rel="icon" type="image/png" sizes="64x64" href="../assets/img/Logo TF.png" />
    <title>Logística</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../styles/styles.css" />
    <link rel="stylesheet" href="../styles/logistica.css" />
    <link rel="stylesheet" href="../styles/backend-indicator.css" />
    <!-- Estilos para el componente searchable-select -->
    <link rel="stylesheet" href="../assets/styles/searchable-select.css" />

    <!-- Bootstrap JavaScript (requerido para modales) - SIN defer para que cargue inmediatamente -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Verificar que Bootstrap se cargó correctamente
      if (typeof bootstrap === 'undefined') {
        console.error('❌ Bootstrap no se cargó correctamente');
      } else {
        console.log('✅ Bootstrap cargado correctamente');
      }
    </script>

    <!-- CRÍTICO: Ocultar elementos del sidebar INMEDIATAMENTE para evitar parpadeo -->
    <style>
      /* Ocultar todos los módulos del sidebar inicialmente */
      .nav-item:not(#nav-menu) {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
      }
      /* Permitir que auth.js muestre los elementos con permisos */
      .nav-item.permission-granted {
        display: list-item !important;
        visibility: visible !important;
        opacity: 1 !important;
        height: auto !important;
        overflow: visible !important;
      }
    </style>

    <!-- Estilos duplicados eliminados - ya están en styles/logistica.css -->

    <!-- Script crítico: Restaurar estado del sidebar ANTES de renderizar para evitar parpadeo -->
    <script src="../assets/scripts/logistica/sidebar-state.js"></script>
    <!-- Script para actualizar período automáticamente -->
    <script src="../assets/scripts/periodo.js"></script>

    <!-- Performance Optimizations y Loaders Comunes -->
    <script src="../assets/scripts/performance/performance-init.js" defer></script>

    <!-- CRÍTICO: auth.js DEBE cargarse ANTES de common-head-loader.js -->
    <!-- para que los permisos se apliquen antes de que se oculten elementos -->
    <script src="../assets/scripts/auth.js"></script>

    <!-- Ahora cargar common-head-loader.js que esperará a que auth.js esté listo -->
    <script src="../assets/scripts/performance/common-head-loader.js"></script>
    <script src="../assets/scripts/script-loader.js" defer></script>

    <!-- ===== FASE 3: Scripts Base del Sistema (SIN defer) ===== -->
    <!-- CRÍTICO: main.js debe cargarse SIN defer para que initializeRegistrationSystem y generateUniqueNumber estén disponibles antes de page-init.js -->
    <script src="../assets/scripts/main.js"></script>
    <!-- CRÍTICO: cache-manager.js debe cargarse ANTES de otros scripts que usan caché -->
    <script src="../assets/scripts/cache-manager.js"></script>
    <!-- CRÍTICO: license-manager.js y plan-limits-manager.js deben cargarse ANTES de data-persistence.js -->
    <script src="../assets/scripts/license-manager.js"></script>
    <script src="../assets/scripts/plan-limits-manager.js"></script>
    <!-- CRÍTICO: data-persistence.js debe cargarse ANTES de otros scripts que usan persistencia -->
    <script src="../assets/scripts/data-persistence.js"></script>

    <!-- ===== FASE 4: Firebase (SIN defer) ===== -->
    <!-- CRÍTICO: firebase-init.js debe cargarse PRIMERO para inicializar Firebase -->
    <script type="module" src="../assets/scripts/firebase-init.js"></script>
    <!-- CRÍTICO: firebase-ready.js debe cargarse DESPUÉS de firebase-init.js para verificar disponibilidad -->
    <script src="../assets/scripts/firebase-ready.js"></script>
    <!-- CRÍTICO: registration-number-binding.js debe cargarse DESPUÉS de firebase-ready.js pero ANTES de main.js -->
    <script src="../assets/scripts/registration-number-binding.js"></script>

    <!-- ===== FASE 5: Scripts con defer (se ejecutan cuando DOM está listo) ===== -->
    <!-- CRÍTICO: firebase-repo-base.js debe cargarse para que FirebaseRepoBase esté disponible -->
    <script src="../assets/scripts/firebase-repo-base.js" defer></script>
    <!-- CRÍTICO: firebase-repos.js debe cargarse DESPUÉS de firebase-repo-base.js para crear los repositorios -->
    <script src="../assets/scripts/firebase-repos.js" defer></script>

    <!-- Scripts específicos del módulo -->
    <script src="../assets/scripts/shared/event-handlers.js" defer></script>
    <!-- CRÍTICO: form-handler.js debe cargarse ANTES de event-handlers.js para que clearCurrentForm esté disponible -->
    <script src="../assets/scripts/logistica/form-handler.js"></script>
    <!-- CRÍTICO: clientes-manager.js debe cargarse ANTES de page-init.js -->
    <script src="../assets/scripts/logistica/clientes-manager.js"></script>
    <!-- Scripts del componente searchable-select -->
    <script src="../assets/scripts/searchable-select.js"></script>
    <!-- Script de inicialización para searchable-select de clientes -->
    <script src="../assets/scripts/logistica/searchable-select-clientes.js" defer></script>
    <!-- CRÍTICO: filtros-manager.js debe cargarse ANTES de event-handlers.js para que aplicarFiltrosLogistica esté disponible -->
    <script src="../assets/scripts/logistica/filtros-manager.js"></script>
    <script src="../assets/scripts/logistica/event-handlers.js" defer></script>
    <script src="../assets/scripts/logistica/export-utils.js" defer></script>
    <script src="../assets/scripts/logistica/registros-loader.js" defer></script>
    <script src="../assets/scripts/logistica/registros-view.js" defer></script>
    <script src="../assets/scripts/logistica/registros-edit.js" defer></script>
    <script src="../assets/scripts/logistica/registros-save.js" defer></script>
    <script src="../assets/scripts/logistica/registros-pdf.js" defer></script>
    <script src="../assets/scripts/logistica/registros-delete.js" defer></script>
    <script src="../assets/scripts/logistica/page-init.js" defer></script>
    <script src="../assets/scripts/paginacion.js" defer></script>

    <!-- Sistema de limpieza automática de localStorage -->
    <script src="../assets/scripts/localstorage-cleanup.js" defer></script>

    <!-- Script de diagnóstico para problemas de numeración -->
    <script src="../assets/scripts/diagnosticar-2500006.js" defer></script>

    <!-- Scripts redundantes eliminados - auth.js ya maneja los permisos automáticamente -->
  </head>

  <body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <img src="../assets/img/Logo TF.png" alt="TitanFleet" style="height: 50px; width: auto" />
          <span class="logo-text">TitanFleet</span>
        </div>
        <button class="btn-close-sidebar" id="closeSidebar"><i class="fas fa-times"></i></button>
      </div>
      <nav class="sidebar-nav">
        <ul class="nav-menu">
          <li class="nav-item" id="nav-menu">
            <a href="menu.html" class="nav-link"
              ><i class="fa-solid fa-house-chimney"></i><span>Menú</span></a
            >
          </li>
          <li class="nav-item" id="nav-logistica">
            <a href="logistica.html" class="nav-link"
              ><i class="fas fa-truck"></i><span>Logística</span></a
            >
          </li>
          <li class="nav-item" id="nav-facturacion">
            <a href="facturacion.html" class="nav-link"
              ><i class="fas fa-file-invoice"></i><span>Facturación</span></a
            >
          </li>
          <li class="nav-item" id="nav-trafico">
            <a href="trafico.html" class="nav-link"
              ><i class="fas fa-route"></i><span>Tráfico</span></a
            >
          </li>
          <li class="nav-item" id="nav-operadores">
            <a href="operadores.html" class="nav-link"
              ><i class="fas fa-user"></i><span>Operadores</span></a
            >
          </li>
          <li class="nav-item" id="nav-diesel">
            <a href="diesel.html" class="nav-link"
              ><i class="fa-solid fa-gas-pump"></i><span>Diesel</span></a
            >
          </li>
          <li class="nav-item" id="nav-mantenimiento">
            <a href="mantenimiento.html" class="nav-link"
              ><i class="fa-solid fa-screwdriver-wrench"></i><span>Mantenimiento</span></a
            >
          </li>
          <li class="nav-item" id="nav-tesoreria">
            <a href="tesoreria.html" class="nav-link"
              ><i class="fa-solid fa-money-bill"></i><span>Tesoreria</span></a
            >
          </li>
          <li class="nav-item" id="nav-cxc">
            <a href="CXC.html" class="nav-link"
              ><i class="fas fa-hand-holding-usd"></i><span>Cuentas x Cobrar</span></a
            >
          </li>
          <li class="nav-item" id="nav-cxp">
            <a href="CXP.html" class="nav-link"
              ><i class="fas fa-credit-card"></i><span>Cuentas x Pagar</span></a
            >
          </li>
          <li class="nav-item active" id="nav-inventario">
            <a href="inventario.html" class="nav-link"
              ><i class="fa-solid fa-cart-flatbed"></i><span>Inventario</span></a
            >
          </li>
          <li class="nav-item" id="nav-configuracion">
            <a href="configuracion.html" class="nav-link"
              ><i class="fa-solid fa-gears"></i><span>Configuración</span></a
            >
          </li>
          <li class="nav-item" id="nav-reportes">
            <a href="reportes.html" class="nav-link"
              ><i class="fas fa-chart-line"></i><span>Reportes</span></a
            >
          </li>
        </ul>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
      <!-- Top Bar -->
      <div class="top-bar">
        <button class="btn-toggle-sidebar" id="toggleSidebar">
          <i class="fas fa-bars"></i>
        </button>
        <div class="top-bar-content">
          <div class="page-title-section">
            <h1 class="page-title">
              <i class="fas fa-truck"></i>
              Gestión Logística
              <span
                id="backendReadyIndicator"
                class="backend-loading-indicator"
                style="display: none"
              >
                <span
                  class="spinner-border spinner-border-sm"
                  role="status"
                  aria-hidden="true"
                ></span>
                <span class="ms-2">Cargando datos...</span>
              </span>
              <span id="backendReadyBadge" class="backend-ready-badge" style="display: none">
                <i class="fas fa-check-circle"></i>
                <span class="ms-2">Listo para trabajar</span>
              </span>
            </h1>
            <div class="current-period">
              <small class="text-muted">Registro: </small>
              <span class="period-info" id="currentPeriod">-</span>
            </div>
          </div>
          <div class="user-info">
            <div class="user-details">
              <i class="fas fa-user-circle"></i>
              <span id="currentUserName">Usuario ERP</span>
            </div>
            <div class="user-actions">
              <button class="btn btn-outline-light btn-sm logout-btn" data-action="logout">
                <i class="fas fa-sign-out-alt"></i> <span class="logout-text">Cerrar Sesión</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Content Container with padding -->
      <div style="padding: 20px">
        <!-- Page Header -->
        <div class="page-header">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h2 class="mb-2">Gestión Logística</h2>
              <p class="text-muted mb-0">
                Complete el formulario para registrar un nuevo envío de mercancía
              </p>
            </div>
            <div class="col-md-4 text-end">
              <!-- Botones removidos según solicitud -->
            </div>
          </div>
        </div>

        <!-- Form -->
        <div class="card">
          <div class="card-body">
            <form class="needs-validation" novalidate>
              <!-- Número de Registro -->
              <div class="form-section">
                <h4 class="section-title">
                  <i class="fas fa-hashtag"></i>
                  Información del Registro
                </h4>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="numeroRegistro" class="form-label">Número de Registro *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="numeroRegistro"
                      placeholder="Se generará automáticamente"
                      readonly
                    />
                    <small class="text-muted"
                      >Este número se genera automáticamente y se mantiene fijo hasta completar el
                      registro. Se usará para rastrear el envío en todos los departamentos.</small
                    >
                    <div class="mt-2">
                      <span class="badge bg-success" id="registrationStatus">
                        <i class="fas fa-check-circle"></i> Número Activo
                      </span>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="fechaCreacion" class="form-label">Fecha de Creación</label>
                    <input type="text" class="form-control" id="fechaCreacion" readonly />
                  </div>
                </div>
              </div>

              <!-- Datos del Cliente -->
              <div class="form-section">
                <h4 class="section-title">
                  <i class="fas fa-user"></i>
                  Datos del Cliente
                </h4>

                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="cliente" class="form-label">Cliente *</label>
                    <div class="d-flex gap-2">
                      <div class="flex-grow-1">
                        <div class="searchable-select-container">
                          <div class="search-input-wrapper">
                            <input
                              type="text"
                              id="cliente"
                              class="form-control"
                              placeholder="Escriba para buscar cliente..."
                              autocomplete="off"
                              required
                            />
                            <i class="fas fa-search search-icon"></i>
                            <button
                              id="btn-clear-cliente"
                              class="btn btn-outline-secondary btn-sm btn-clear"
                              type="button"
                              title="Limpiar"
                            >
                              <i class="fas fa-times"></i>
                            </button>
                          </div>
                          <div id="select-cliente" class="filtered-select"></div>
                        </div>
                        <input type="hidden" id="cliente_value" />
                      </div>
                    </div>
                    <small class="text-muted"
                      >Los datos se llenarán automáticamente al seleccionar</small
                    >
                  </div>
                  <div class="col-md-6">
                    <label for="rfcCliente" class="form-label">RFC *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="rfcCliente"
                      placeholder="Se llena automáticamente"
                      readonly
                    />
                  </div>

                  <div class="col-md-6">
                    <label for="origen" class="form-label">Ciudad Origen </label>
                    <input
                      type="text"
                      class="form-control"
                      id="origen"
                      placeholder="Ciudad de origen"
                      required
                    />
                    <div class="invalid-feedback">Por favor ingrese la ciudad de origen</div>
                  </div>

                  <div class="col-md-6">
                    <label for="destino" class="form-label">Ciudad Destino </label>
                    <input
                      type="text"
                      class="form-control"
                      id="destino"
                      placeholder="Ciudad de destino"
                      required
                    />
                    <div class="invalid-feedback">Por favor ingrese la ciudad de destino</div>
                  </div>

                  <div class="col-md-6">
                    <label for="referencia cliente" class="form-label"
                      >Referencia del Cliente
                    </label>
                    <input
                      type="text"
                      class="form-control"
                      id="referencia cliente"
                      placeholder="Referencia del Cliente"
                      required
                    />
                    <div class="invalid-feedback">Por favor ingrese la Referencia del Cliente</div>
                  </div>
                </div>
              </div>

              <!-- Detalles del Envío -->
              <div class="form-section">
                <h4 class="section-title">
                  <i class="fa-solid fa-boxes-packing"></i>
                  Detalles del Envío
                </h4>
                <div class="row g-3">
                  <div class="col-md-4">
                    <label for="plataforma" class="form-label">Tipo de Plataforma </label>
                    <select id="plataforma" class="form-select" required>
                      <option value="">Seleccione...</option>
                      <option value="48ft">48 ft</option>
                      <option value="53ft">53 ft</option>
                      <option value="extendible">Extendible</option>
                      <option value="step-deck">Step-Deck</option>
                      <option value="lowboy">Lowboy</option>
                    </select>
                    <div class="invalid-feedback">Por favor seleccione el tipo de plataforma</div>
                  </div>
                  <div class="col-md-8">
                    <label for="mercancia" class="form-label">Tipo de Mercancía </label>
                    <input
                      type="text"
                      class="form-control"
                      id="mercancia"
                      placeholder="Descripción de la mercancía"
                      required
                    />
                    <div class="invalid-feedback">Por favor ingrese el tipo de mercancía</div>
                  </div>

                  <div class="col-md-4">
                    <label for="peso" class="form-label">Peso (kg) *</label>
                    <div class="input-group">
                      <input
                        type="number"
                        class="form-control"
                        id="peso"
                        placeholder="0"
                        required
                      />
                      <span class="input-group-text">kg</span>
                    </div>
                    <div class="invalid-feedback">Por favor ingrese el peso</div>
                  </div>
                  <div class="col-md-4">
                    <label for="largo" class="form-label">Largo (m) *</label>
                    <div class="input-group">
                      <input
                        type="number"
                        class="form-control"
                        id="largo"
                        placeholder="0"
                        step="0.01"
                        required
                      />
                      <span class="input-group-text">m</span>
                    </div>
                    <div class="invalid-feedback">Por favor ingrese el largo</div>
                  </div>
                  <div class="col-md-4">
                    <label for="ancho" class="form-label">Ancho (m) *</label>
                    <div class="input-group">
                      <input
                        type="number"
                        class="form-control"
                        id="ancho"
                        placeholder="0"
                        step="0.01"
                        required
                      />
                      <div class="invalid-feedback">Por favor ingrese el ancho</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Servicio -->
              <div class="form-section">
                <h4 class="section-title">
                  <i class="fas fa-cogs"></i>
                  Configuración del Servicio
                </h4>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="servicio" class="form-label">Tipo de Servicio </label>
                    <select id="servicio" class="form-select" required>
                      <option value="">Seleccione...</option>
                      <option value="general">General</option>
                      <option value="urgente">Urgente</option>
                      <option value="doble-operador">Doble Operador</option>
                    </select>
                    <div class="invalid-feedback">Por favor seleccione el tipo de servicio</div>
                  </div>
                  <div class="col-md-6">
                    <label for="fecha" class="form-label">Fecha de Envío </label>
                    <input type="date" class="form-control" id="fecha" required />
                    <div class="invalid-feedback">Por favor seleccione la fecha de envío</div>
                  </div>
                </div>
              </div>

              <!-- Embalaje Especial -->
              <div class="form-section">
                <h4 class="section-title">
                  <i class="fa-solid fa-clipboard"></i>
                  Embalaje Especial
                </h4>
                <div class="row g-3">
                  <div class="col-12">
                    <div class="form-check form-check-inline">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="embalaje"
                        id="embalajeSi"
                        value="si"
                      />
                      <label class="form-check-label" for="embalajeSi">Sí</label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="embalaje"
                        id="embalajeNo"
                        value="no"
                        checked
                      />
                      <label class="form-check-label" for="embalajeNo">No</label>
                    </div>
                  </div>
                  <div class="col-12 descripcion-embalaje-hidden" id="descripcionEmbalaje">
                    <label for="descripcion" class="form-label">Descripción del Embalaje</label>
                    <textarea
                      class="form-control"
                      id="descripcion"
                      rows="3"
                      placeholder="Describa los requisitos especiales de embalaje..."
                    ></textarea>
                  </div>
                </div>
              </div>

              <!-- Botones de Acción -->
              <div class="form-actions">
                <button
                  type="button"
                  class="btn btn-outline-warning me-2"
                  data-action="clearCurrentForm"
                >
                  <i class="fas fa-times"></i> Limpiar
                </button>
                <button type="submit" class="btn btn-primary me-2">
                  <i class="fas fa-check"></i> Registrar Envío
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Lista de Registros de Logística -->
        <div class="card mt-4">
          <div
            class="card-header d-flex justify-content-between align-items-center card-header-logistica"
          >
            <h5 class="card-title mb-0 card-title-logistica">
              <i class="fas fa-list"></i> Registros de Logística
            </h5>
            <button
              type="button"
              class="btn btn-outline-light btn-sm exportar-btn-header"
              data-action="exportarLogisticaExcel"
            >
              <i class="fas fa-file-excel"></i> Exportar
            </button>
          </div>
          <!-- Filtros -->
          <div class="card-body border-bottom card-body-filters">
            <h6 class="mb-3"><i class="fas fa-filter"></i> Filtros de Búsqueda</h6>
            <div class="row g-3">
              <div class="col-md-3">
                <label for="filtroReferencia" class="form-label small">N° Registro</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="filtroReferencia"
                  placeholder="Ej: 2500001"
                  data-action="aplicarFiltrosLogistica"
                />
              </div>
              <div class="col-md-3">
                <label for="filtroCliente" class="form-label small">Cliente</label>
                <select
                  class="form-select form-select-sm"
                  id="filtroCliente"
                  data-action="aplicarFiltrosLogistica"
                >
                  <option value="">Todos los clientes</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="filtroReferenciaCliente" class="form-label small"
                  >Referencia Cliente</label
                >
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="filtroReferenciaCliente"
                  placeholder="Referencia del cliente"
                  data-action="aplicarFiltrosLogistica"
                />
              </div>
              <div class="col-md-3">
                <label for="filtroTipoServicio" class="form-label small">Tipo Servicio</label>
                <select
                  class="form-select form-select-sm"
                  id="filtroTipoServicio"
                  data-action="aplicarFiltrosLogistica"
                >
                  <option value="">Todos</option>
                  <option value="general">General</option>
                  <option value="urgente">Urgente</option>
                  <option value="doble-operador">Doble Operador</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="filtroFechaInicial" class="form-label small">Fecha Inicio</label>
                <input
                  type="date"
                  class="form-control form-control-sm"
                  id="filtroFechaInicial"
                  data-action="aplicarFiltrosLogistica"
                />
              </div>
              <div class="col-md-3">
                <label for="filtroFechaFinal" class="form-label small">Fecha Fin</label>
                <input
                  type="date"
                  class="form-control form-control-sm"
                  id="filtroFechaFinal"
                  data-action="aplicarFiltrosLogistica"
                />
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm w-100"
                  data-action="limpiarFiltrosLogistica"
                >
                  <i class="fas fa-times"></i> Limpiar Filtros
                </button>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover" id="tablaRegistrosLogistica">
                <thead class="table-dark">
                  <tr>
                    <th>N° Registro</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Referencia Cliente</th>
                    <th>Tipo Servicio</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="cuerpoTablaLogistica">
                  <tr>
                    <td colspan="8" class="text-center text-muted">
                      <i class="fas fa-inbox"></i> No hay registros de Logística
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="paginacionLogistica"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Script para indicador de carga del backend (compartido) -->
    <script src="../assets/scripts/backend-ready-indicator.js"></script>
  </body>
</html>
