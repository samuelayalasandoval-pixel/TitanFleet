<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpiar Todos los Registros</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #d32f2f;
            margin-top: 0;
        }
        .warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .warning h2 {
            margin-top: 0;
            color: #856404;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .data-list {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
        .data-item {
            padding: 5px;
            margin: 5px 0;
            background: #f0f0f0;
            border-radius: 3px;
        }
        button {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .btn-backup {
            background: #1976d2;
            color: white;
        }
        .btn-backup:hover {
            background: #1565c0;
        }
        .btn-clean {
            background: #d32f2f;
            color: white;
        }
        .btn-clean:hover {
            background: #c62828;
        }
        .btn-success {
            background: #388e3c;
            color: white;
        }
        .btn-success:hover {
            background: #2e7d32;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .stat-box {
            padding: 15px;
            background: #e3f2fd;
            border-radius: 5px;
            text-align: center;
        }
        .stat-box h4 {
            margin: 0 0 10px 0;
            font-size: 12px;
            color: #666;
        }
        .stat-box .number {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
        }
        .actions {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
        }
        .checkbox-group {
            margin: 15px 0;
        }
        .checkbox-group label {
            display: block;
            margin: 8px 0;
            cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóëÔ∏è Limpiar Todos los Registros</h1>
        
        <div class="warning">
            <h2>‚ö†Ô∏è ADVERTENCIA</h2>
            <p><strong>Esta acci√≥n eliminar√° TODOS los registros de datos del sistema.</strong></p>
            <ul>
                <li>‚úÖ Se eliminar√°n: Registros de log√≠stica, facturaci√≥n, tr√°fico, diesel, operadores, mantenimiento, tesorer√≠a, CXC, CXP, inventario</li>
                <li>‚ùå NO se eliminar√°n: Configuraci√≥n del sistema, usuarios, estancias, tractocamiones, etc.</li>
                <li>‚ö†Ô∏è Esta acci√≥n NO se puede deshacer (a menos que tengas un backup)</li>
            </ul>
        </div>

        <div class="section">
            <h3>üìä Resumen de Datos a Eliminar</h3>
            <div class="stats" id="stats"></div>
        </div>

        <div class="section">
            <h3>üîç Datos que se Eliminar√°n</h3>
            <div id="dataToDelete"></div>
        </div>

        <div class="section">
            <h3>‚úÖ Datos que se Conservar√°n</h3>
            <div id="dataToKeep"></div>
        </div>

        <div class="section">
            <h3>‚öôÔ∏è Opciones</h3>
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="includeFirebase" checked>
                    <strong>Incluir datos de Firebase</strong> (requiere autenticaci√≥n)
                </label>
                <label>
                    <input type="checkbox" id="includeLocalStorage" checked>
                    <strong>Incluir datos de localStorage</strong>
                </label>
                <label>
                    <input type="checkbox" id="createBackup" checked>
                    <strong>Crear backup autom√°tico antes de limpiar</strong>
                </label>
            </div>
        </div>

        <div class="actions">
            <button class="btn-backup" onclick="crearBackup()">üíæ Crear Backup Ahora</button>
            <button class="btn-clean" onclick="limpiarDatos()">üóëÔ∏è Limpiar Todos los Registros</button>
        </div>

        <div id="status" class="status"></div>
    </div>

    <script>
        // Claves que se ELIMINAR√ÅN (registros de datos)
        const keysToDelete = [
            'erp_shared_data', // Contiene registros, facturas, tr√°fico, etc.
            'erp_logistica',
            'erp_facturacion',
            'erp_trafico',
            'erp_diesel_movimientos',
            'erp_operadores_gastos',
            'erp_operadores_incidencias', // Incidencias de operadores
            'erp_mantenimientos',
            'erp_tesoreria_movimientos',
            'erp_cxc',
            'erp_cxp',
            'erp_inventario_movimientos',
            'erp_inventario_plataformas' // Plataformas del inventario (se pueden regenerar)
        ];

        // Claves que se CONSERVAR√ÅN (configuraci√≥n del sistema)
        const keysToKeep = [
            'erpCurrentUser',
            'erp_shared_data', // Solo se limpiar√°n las secciones de registros, no toda la clave
            'erp_estancias',
            'erp_tractocamiones',
            'erp_operadores',
            'erp_clientes',
            'erp_configuracion',
            'tenantId',
            'firebase_auth',
            'firebase_user'
        ];

        function analizarDatos() {
            const stats = {
                totalKeys: 0,
                totalRecords: 0,
                totalSize: 0
            };

            const dataToDelete = [];
            const dataToKeep = [];

            // Analizar erp_shared_data (solo las secciones de registros)
            const sharedData = localStorage.getItem('erp_shared_data');
            if (sharedData) {
                try {
                    const data = JSON.parse(sharedData);
                    const sectionsToDelete = ['registros', 'facturas', 'facturacion', 'trafico', 'diesel', 'mantenimiento', 'tesoreria', 'cxc', 'cxp', 'inventario', 'incidencias'];
                    
                    sectionsToDelete.forEach(section => {
                        if (data[section] && typeof data[section] === 'object') {
                            const count = Object.keys(data[section]).length;
                            if (count > 0) {
                                stats.totalRecords += count;
                                dataToDelete.push({
                                    clave: `erp_shared_data.${section}`,
                                    cantidad: count
                                });
                            }
                        }
                    });
                } catch (e) {
                    console.error('Error analizando erp_shared_data:', e);
                }
            }

            // Analizar otras claves
            keysToDelete.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        const count = Array.isArray(parsed) ? parsed.length : 
                                     (typeof parsed === 'object' ? Object.keys(parsed).length : 0);
                        if (count > 0) {
                            stats.totalKeys++;
                            stats.totalRecords += count;
                            stats.totalSize += data.length;
                            dataToDelete.push({
                                clave: key,
                                cantidad: count
                            });
                        }
                    } catch (e) {
                        // Si no es JSON, contar como string
                        if (data.length > 0) {
                            stats.totalKeys++;
                            stats.totalSize += data.length;
                            dataToDelete.push({
                                clave: key,
                                cantidad: 'Datos (no JSON)'
                            });
                        }
                    }
                }
            });

            // Mostrar claves que se conservar√°n
            keysToKeep.forEach(key => {
                const data = localStorage.getItem(key);
                if (data && !keysToDelete.includes(key)) {
                    dataToKeep.push({
                        clave: key,
                        existe: true
                    });
                }
            });

            return { stats, dataToDelete, dataToKeep };
        }

        function mostrarResultados() {
            const { stats, dataToDelete, dataToKeep } = analizarDatos();

            // Mostrar estad√≠sticas
            document.getElementById('stats').innerHTML = `
                <div class="stat-box">
                    <h4>Claves a Eliminar</h4>
                    <div class="number">${stats.totalKeys + dataToDelete.filter(d => d.clave.includes('.')).length}</div>
                </div>
                <div class="stat-box">
                    <h4>Registros a Eliminar</h4>
                    <div class="number">${stats.totalRecords}</div>
                </div>
                <div class="stat-box">
                    <h4>Tama√±o Aprox.</h4>
                    <div class="number">${(stats.totalSize / 1024).toFixed(2)} KB</div>
                </div>
            `;

            // Mostrar datos a eliminar
            let deleteHTML = '<div class="data-list">';
            if (dataToDelete.length === 0) {
                deleteHTML += '<p style="color: green;">‚úÖ No hay datos para eliminar</p>';
            } else {
                dataToDelete.forEach(item => {
                    deleteHTML += `<div class="data-item">
                        <strong>${item.clave}</strong>: ${item.cantidad} ${typeof item.cantidad === 'number' ? 'registros' : ''}
                    </div>`;
                });
            }
            deleteHTML += '</div>';
            document.getElementById('dataToDelete').innerHTML = deleteHTML;

            // Mostrar datos a conservar
            let keepHTML = '<div class="data-list">';
            if (dataToKeep.length === 0) {
                keepHTML += '<p>No hay datos de configuraci√≥n para conservar</p>';
            } else {
                dataToKeep.forEach(item => {
                    keepHTML += `<div class="data-item">
                        <strong>${item.clave}</strong>: ‚úÖ Se conservar√°
                    </div>`;
                });
            }
            keepHTML += '</div>';
            document.getElementById('dataToKeep').innerHTML = keepHTML;
        }

        function crearBackup() {
            const backup = {
                fecha: new Date().toISOString(),
                datos: {}
            };

            // Backup de erp_shared_data (solo secciones de registros)
            const sharedData = localStorage.getItem('erp_shared_data');
            if (sharedData) {
                try {
                    const data = JSON.parse(sharedData);
                    const sectionsToBackup = ['registros', 'facturas', 'facturacion', 'trafico', 'diesel', 'mantenimiento', 'tesoreria', 'cxc', 'cxp', 'inventario'];
                    const backupData = {};
                    
                    sectionsToBackup.forEach(section => {
                        if (data[section]) {
                            backupData[section] = data[section];
                        }
                    });
                    
                    if (Object.keys(backupData).length > 0) {
                        backup.datos['erp_shared_data'] = backupData;
                    }
                } catch (e) {
                    console.error('Error en backup de erp_shared_data:', e);
                }
            }

            // Backup de otras claves
            keysToDelete.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        backup.datos[key] = JSON.parse(data);
                    } catch (e) {
                        backup.datos[key] = data; // Guardar como string si no es JSON
                    }
                }
            });

            // Descargar backup
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-registros-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            mostrarMensaje('‚úÖ Backup creado y descargado correctamente', 'success');
        }

        function limpiarDatos() {
            if (!confirm('‚ö†Ô∏è ¬øEST√ÅS SEGURO de que quieres eliminar TODOS los registros?\n\nEsta acci√≥n NO se puede deshacer.')) {
                return;
            }

            if (!confirm('‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN:\n\nSe eliminar√°n todos los registros de:\n- Log√≠stica\n- Facturaci√≥n\n- Tr√°fico\n- Diesel\n- Operadores\n- Mantenimiento\n- Tesorer√≠a\n- CXC\n- CXP\n- Inventario\n\n¬øContinuar?')) {
                return;
            }

            let eliminados = 0;
            const includeLocalStorage = document.getElementById('includeLocalStorage').checked;
            const createBackup = document.getElementById('createBackup').checked;

            // Crear backup si est√° marcado
            if (createBackup) {
                crearBackup();
                // Esperar un momento para que se descargue el backup
                setTimeout(() => {
                    ejecutarLimpieza(includeLocalStorage);
                }, 1000);
            } else {
                ejecutarLimpieza(includeLocalStorage);
            }
        }

        function ejecutarLimpieza(includeLocalStorage) {
            let eliminados = 0;

            if (includeLocalStorage) {
                // Limpiar secciones de erp_shared_data
                const sharedData = localStorage.getItem('erp_shared_data');
                if (sharedData) {
                    try {
                        const data = JSON.parse(sharedData);
                        const sectionsToDelete = ['registros', 'facturas', 'facturacion', 'trafico', 'diesel', 'mantenimiento', 'tesoreria', 'cxc', 'cxp', 'inventario'];
                        
                        sectionsToDelete.forEach(section => {
                            if (data[section]) {
                                let count = 0;
                                if (typeof data[section] === 'object') {
                                    count = Array.isArray(data[section]) ? data[section].length : Object.keys(data[section]).length;
                                }
                                delete data[section];
                                eliminados += count;
                            }
                        });
                        
                        // Guardar los datos limpiados (incluso si est√° vac√≠o, para mantener la estructura)
                        localStorage.setItem('erp_shared_data', JSON.stringify(data));
                        console.log('‚úÖ erp_shared_data limpiado, eliminados:', eliminados);
                    } catch (e) {
                        console.error('Error limpiando erp_shared_data:', e);
                        // Si hay error parseando, eliminar toda la clave
                        localStorage.removeItem('erp_shared_data');
                        eliminados++;
                    }
                }

                // Eliminar otras claves
                keysToDelete.forEach(key => {
                    if (key !== 'erp_shared_data') { // Ya se limpi√≥ arriba
                        const data = localStorage.getItem(key);
                        if (data) {
                            try {
                                const parsed = JSON.parse(data);
                                const count = Array.isArray(parsed) ? parsed.length : 
                                             (typeof parsed === 'object' ? Object.keys(parsed).length : 0);
                                eliminados += count;
                            } catch (e) {
                                eliminados++;
                            }
                            localStorage.removeItem(key);
                        }
                    }
                });
            }

            // Limpiar Firebase si est√° marcado
            const includeFirebase = document.getElementById('includeFirebase').checked;
            if (includeFirebase && window.firebaseRepos) {
                limpiarFirebase().then(() => {
                    mostrarMensaje(`‚úÖ Limpieza completada. ${eliminados} registros eliminados de localStorage${includeFirebase ? ' y Firebase' : ''}`, 'success');
                    mostrarResultados();
                }).catch(error => {
                    mostrarMensaje(`‚ö†Ô∏è Limpieza de localStorage completada (${eliminados} registros), pero hubo un error con Firebase: ${error.message}`, 'error');
                    mostrarResultados();
                });
            } else {
                mostrarMensaje(`‚úÖ Limpieza completada. ${eliminados} registros eliminados de localStorage`, 'success');
                mostrarResultados();
            }
        }

        async function limpiarFirebase() {
            if (!window.firebaseRepos || !window.firebaseAuth?.currentUser) {
                throw new Error('Firebase no est√° disponible o no hay usuario autenticado');
            }

            const repos = ['logistica', 'facturacion', 'trafico', 'diesel', 'mantenimiento', 'tesoreria', 'cxc', 'cxp', 'inventario'];
            const resultados = [];

            for (const repoName of repos) {
                const repo = window.firebaseRepos[repoName];
                if (repo && repo.db && repo.tenantId) {
                    try {
                        // Obtener todos los registros
                        const registros = await repo.getAll();
                        
                        // Eliminar cada registro
                        for (const registro of registros) {
                            const id = registro.id || registro.numeroRegistro || registro.registroId;
                            if (id) {
                                await repo.delete(id);
                            }
                        }
                        
                        resultados.push(`${repoName}: ${registros.length} registros eliminados`);
                    } catch (error) {
                        console.error(`Error limpiando ${repoName}:`, error);
                        resultados.push(`${repoName}: Error - ${error.message}`);
                    }
                }
            }

            return resultados;
        }

        function mostrarMensaje(mensaje, tipo) {
            const status = document.getElementById('status');
            status.className = `status ${tipo}`;
            status.textContent = mensaje;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        // Cargar resultados al iniciar
        mostrarResultados();
    </script>
</body>
</html>

